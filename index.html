<!DOCTYPE html>
<html lang="en">
  <head>  
    <meta charset="UTF-8" />  
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />  
    <title>Backtest Dashboard</title>  
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>  
    <style>
      /* Added styles for risk metrics and filters */
      .risk-metrics { 
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin: 15px 0;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #3498db;
      }
      .risk-metrics div {
        text-align: center;
      }
      .metric-value {
        font-weight: bold;
        font-size: 1.2rem;
        color: #2c3e50;
      }
      .filters {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr 1fr auto;
        gap: 10px;
        margin: 20px 0;
        align-items: end;
      }
      .filters label {
        margin-bottom: 5px;
      }
      .filters button {
        height: 40px;
      }
      .success-message {
        background: #27ae60;
        color: white;
        padding: 10px;
        border-radius: 5px;
        text-align: center;
        margin-top: 10px;
        display: none;
      }
    </style>  
  </head>  
  <body>  
    <h1>Backtest Dashboard</h1>  
    <div class="form-container">  
      <div class="form-grid">
        <!-- ... existing form fields ... -->
      </div>
      
      <!-- Added Risk Metrics Display -->
      <div class="risk-metrics" id="riskMetrics" style="display: none;">
        <div>
          <div>SL Size (pips)</div>
          <div class="metric-value" id="slSizeDisplay">0.00</div>
        </div>
        <div>
          <div>Risk:Reward</div>
          <div class="metric-value" id="rrDisplay">0.00</div>
        </div>
      </div>
      
      <button onclick="saveTrade()">Save Trade</button>
    </div>

    <div class="export-section">
      <input type="file" id="csvFile" accept=".csv">
      <button onclick="importFromCSV()">Import CSV</button>
      <button class="export-btn" onclick="exportToCSV()">Download CSV</button>
      <!-- Added Success Message -->
      <div class="success-message" id="importSuccess">CSV imported successfully!</div>
    </div>

    <!-- Added Filters -->
    <div class="filters">
      <div>
        <label>Pair</label>
        <select id="filterPair">
          <option value="all">All Pairs</option>
          <option value="EURUSD">EURUSD</option>
          <option value="EURCAD">EURCAD</option>
          <option value="GBPUSD">GBPUSD</option>
          <option value="US30">US30</option>
          <option value="BTCUSD">BTCUSD</option>
        </select>
      </div>
      <div>
        <label>From Date</label>
        <input type="date" id="filterFrom">
      </div>
      <div>
        <label>To Date</label>
        <input type="date" id="filterTo">
      </div>
      <div>
        <label>Result</label>
        <select id="filterResult">
          <option value="all">All Results</option>
          <option value="Win">Win</option>
          <option value="Loss">Loss</option>
        </select>
      </div>
      <div>
        <button onclick="applyFilters()">Apply Filters</button>
        <button onclick="resetFilters()">Reset</button>
      </div>
    </div>

    <div class="stats-section" id="monthlyStats"></div>
    <div class="scroll-table-container" id="entriesTable"></div>

    <script>
      let trades = JSON.parse(localStorage.getItem("trades")) || [];
      let currentFilters = {
        pair: "all",
        fromDate: null,
        toDate: null,
        result: "all"
      };

      // Initialize event listeners for risk metrics
      document.getElementById('entry').addEventListener('input', updateRiskMetrics);
      document.getElementById('sl').addEventListener('input', updateRiskMetrics);
      document.getElementById('tp').addEventListener('input', updateRiskMetrics);

      // 1. Auto-calculate and display SL Size and Risk:Reward
      function updateRiskMetrics() {
        const entry = parseFloat(document.getElementById('entry').value);
        const sl = parseFloat(document.getElementById('sl').value);
        const tp = parseFloat(document.getElementById('tp').value);
        const riskMetrics = document.getElementById('riskMetrics');
        
        if (!isNaN(entry) && !isNaN(sl) && !isNaN(tp)) {
          // Calculate SL Size in pips (assuming 4 decimals for FX, 2 for others)
          const pair = document.getElementById('pair').value;
          const isFX = ['EURUSD', 'EURCAD', 'GBPUSD'].includes(pair);
          const pipFactor = isFX ? 10000 : 100;
          const slSize = Math.abs(entry - sl) * pipFactor;
          
          // Calculate Risk:Reward ratio
          const rr = Math.abs(tp - entry) / Math.abs(sl - entry);
          
          document.getElementById('slSizeDisplay').textContent = slSize.toFixed(2);
          document.getElementById('rrDisplay').textContent = rr.toFixed(2);
          riskMetrics.style.display = 'grid';
        } else {
          riskMetrics.style.display = 'none';
        }
      }

      function saveTrade() {
        // Existing save logic plus validation
        const entry = parseFloat(document.getElementById("entry").value);
        const sl = parseFloat(document.getElementById("sl").value);
        const tp = parseFloat(document.getElementById("tp").value);
        const zone = document.getElementById("zone").value;
        
        // 4a. Enhanced validation
        if (zone === "Demand" && (entry <= sl || tp <= entry)) {
          return alert("For Demand zones: Entry > SL and TP > Entry");
        }
        
        if (zone === "Supply" && (entry >= sl || tp >= entry)) {
          return alert("For Supply zones: Entry < SL and TP < Entry");
        }
        
        // Existing save logic...
        trades.push({ /* trade data */ });
        localStorage.setItem("trades", JSON.stringify(trades));
        alert("Trade saved successfully");
        
        // Reset risk metrics display
        document.getElementById('riskMetrics').style.display = 'none';
        renderStats();
        renderTable();
      }

      // 2. Success message for CSV imports
      function importFromCSV() {
        // ... existing import logic ...
        
        // After successful import:
        const successMsg = document.getElementById('importSuccess');
        successMsg.style.display = 'block';
        successMsg.textContent = `Successfully imported ${lines.length - 1} trades!`;
        
        // Hide after 3 seconds
        setTimeout(() => successMsg.style.display = 'none', 3000);
      }

      // 3. Trade filtering
      function applyFilters() {
        currentFilters = {
          pair: document.getElementById('filterPair').value,
          fromDate: document.getElementById('filterFrom').value,
          toDate: document.getElementById('filterTo').value,
          result: document.getElementById('filterResult').value
        };
        renderTable();
      }
      
      function resetFilters() {
        document.getElementById('filterPair').value = 'all';
        document.getElementById('filterFrom').value = '';
        document.getElementById('filterTo').value = '';
        document.getElementById('filterResult').value = 'all';
        currentFilters = {
          pair: "all",
          fromDate: null,
          toDate: null,
          result: "all"
        };
        renderTable();
      }

      function renderTable() {
        // Apply filters
        let filteredTrades = trades.filter(trade => {
          if (currentFilters.pair !== 'all' && trade.pair !== currentFilters.pair) 
            return false;
          if (currentFilters.result !== 'all' && trade.result !== currentFilters.result) 
            return false;
          
          const tradeDate = new Date(trade.date);
          if (currentFilters.fromDate && new Date(currentFilters.fromDate) > tradeDate) 
            return false;
          if (currentFilters.toDate && new Date(currentFilters.toDate) < tradeDate) 
            return false;
            
          return true;
        });
        
        // ... existing table rendering code using filteredTrades ...
      }

      // 4b. Enhanced RR analysis in stats
      function renderStats() {
        // ... existing stats code ...
        
        // Add RR distribution analysis
        const rrGroups = {
          '<1.0': 0,
          '1.0-1.5': 0,
          '1.5-2.0': 0,
          '2.0-3.0': 0,
          '>3.0': 0
        };
        
        const winRatesByRR = {
          '<1.0': { wins: 0, total: 0 },
          '1.0-1.5': { wins: 0, total: 0 },
          '1.5-2.0': { wins: 0, total: 0 },
          '2.0-3.0': { wins: 0, total: 0 },
          '>3.0': { wins: 0, total: 0 }
        };
        
        trades.forEach(trade => {
          // RR distribution
          if (trade.rr < 1) {
            rrGroups['<1.0']++;
            updateWinRateStats(winRatesByRR, '<1.0', trade);
          } 
          else if (trade.rr < 1.5) {
            rrGroups['1.0-1.5']++;
            updateWinRateStats(winRatesByRR, '1.0-1.5', trade);
          }
          else if (trade.rr < 2.0) {
            rrGroups['1.5-2.0']++;
            updateWinRateStats(winRatesByRR, '1.5-2.0', trade);
          }
          else if (trade.rr < 3.0) {
            rrGroups['2.0-3.0']++;
            updateWinRateStats(winRatesByRR, '2.0-3.0', trade);
          }
          else {
            rrGroups['>3.0']++;
            updateWinRateStats(winRatesByRR, '>3.0', trade);
          }
        });
        
        // Add RR distribution to stats cards
        statsContainer.innerHTML += `
          <div class="stats-card">
            <h3>RR Distribution</h3>
            <p>&lt;1.0: ${rrGroups['<1.0']} trades</p>
            <p>1.0-1.5: ${rrGroups['1.0-1.5']} trades</p>
            <p>1.5-2.0: ${rrGroups['1.5-2.0']} trades</p>
            <p>2.0-3.0: ${rrGroups['2.0-3.0']} trades</p>
            <p>&gt;3.0: ${rrGroups['>3.0']} trades</p>
          </div>
          
          <div class="stats-card">
            <h3>Win Rate by RR</h3>
            <p>&lt;1.0: ${calculateWinRate(winRatesByRR['<1.0'])}%</p>
            <p>1.0-1.5: ${calculateWinRate(winRatesByRR['1.0-1.5'])}%</p>
            <p>1.5-2.0: ${calculateWinRate(winRatesByRR['1.5-2.0'])}%</p>
            <p>2.0-3.0: ${calculateWinRate(winRatesByRR['2.0-3.0'])}%</p>
            <p>&gt;3.0: ${calculateWinRate(winRatesByRR['>3.0'])}%</p>
          </div>
        `;
      }
      
      function updateWinRateStats(groupObj, groupKey, trade) {
        groupObj[groupKey].total++;
        if (trade.result === "Win") {
          groupObj[groupKey].wins++;
        }
      }
      
      function calculateWinRate(group) {
        return group.total > 0 ? ((group.wins / group.total) * 100).toFixed(1) : '0.0';
      }

      // 4c. Enhanced charting
      function renderStats() {
        // ... existing code ...
        
        // Add RR vs Win Rate scatter plot
        const scatterCanvasId = `scatter_${key.replace(/\s+/g, '_')}`;
        statsContainer.innerHTML += `
          <div class="stats-card">
            <h3>RR vs Win Rate</h3>
            <div class="chart-container">
              <canvas id="${scatterCanvasId}"></canvas>
            </div>
          </div>
        `;
        
        setTimeout(() => {
          const ctx = document.getElementById(scatterCanvasId).getContext('2d');
          new Chart(ctx, {
            type: 'scatter',
            data: {
              datasets: [{
                label: 'Trades',
                data: data.map(trade => ({
                  x: trade.rr,
                  y: trade.result === "Win" ? 1 : 0,
                })),
                backgroundColor: data.map(t => t.result === "Win" ? '#27ae60' : '#e74c3c'),
              }]
            },
            options: {
              scales: {
                x: { title: { display: true, text: 'Risk:Reward' } },
                y: { 
                  ticks: { callback: val => val === 1 ? 'Win' : 'Loss' },
                  title: { display: true, text: 'Result' } 
                }
              }
            }
          });
        }, 100);
      }
    </script>
  </body>
</html>
