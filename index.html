<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Backtest Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; background: #f4f4f4; }
    h1 { text-align: center; color: #333; }
    .form-container, .dashboard, .stats-section, .import-export-container {
      max-width: 1000px;
      margin: 20px auto;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    label { display: block; margin: 10px 0 4px; }
    input, select, button { padding: 10px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #ccc; font-size: 1rem; }
    .row { display: flex; gap: 10px; }
    .row > * { flex: 1; }
    button { background: #333; color: white; border: none; cursor: pointer; }
    button:hover { background: #555; }
    .stats-card { padding: 15px; background: #eee; margin-bottom: 30px; border-radius: 10px; position: relative; }
    .stats-card h3 { margin: 0 0 10px; }
    .chart-container { width: 300px; height: 300px; margin: 20px auto; }
    .table-container { overflow: auto; max-height: 400px; margin-top: 20px; }
    table { border-collapse: collapse; width: 100%; min-width: 1200px; }
    th, td { padding: 8px 12px; border: 1px solid #ccc; text-align: left; }
    .alert-success { background: #d4edda; color: #155724; padding: 10px; border-radius: 5px; margin-bottom: 15px; }
  </style>
</head>
<body>
<h1>Backtest Dashboard</h1>

<div class="form-container">
  <div id="alert"></div>
  <div class="row">
    <div>
      <label>Pair</label>
      <select id="pair">
        <option value="EURUSD">EURUSD</option>
        <option value="EURCAD">EURCAD</option>
        <option value="GBPUSD">GBPUSD</option>
        <option value="US30">US30</option>
        <option value="BTCUSD">BTCUSD</option>
      </select>
    </div>
    <div>
      <label>Date</label>
      <input type="date" id="date">
    </div>
  </div>
  <div class="row">
    <div>
      <label>H4 Direction</label>
      <select id="h4">
        <option value="Bullish">Bullish</option>
        <option value="Bearish">Bearish</option>
      </select>
    </div>
    <div>
      <label>H1 Direction</label>
      <select id="h1">
        <option value="Bullish">Bullish</option>
        <option value="Bearish">Bearish</option>
      </select>
    </div>
  </div>
  <div class="row">
    <div>
      <label>Zone Type</label>
      <select id="zone">
        <option value="Supply">Supply</option>
        <option value="Demand">Demand</option>
      </select>
    </div>
    <div>
      <label>Zone Timeframe</label>
      <select id="zoneTimeframe">
        <option value="M15">M15</option>
        <option value="H1">H1</option>
      </select>
    </div>
  </div>
  <div class="row">
    <div>
      <label>Entry Price</label>
      <input type="number" id="entry" step="0.0001">
    </div>
    <div>
      <label>Stop Loss</label>
      <input type="number" id="sl" step="0.0001">
    </div>
  </div>
  <div class="row">
    <div>
      <label>Take Profit</label>
      <input type="number" id="tp" step="0.0001">
    </div>
    <div>
      <label>Trade Result</label>
      <select id="result">
        <option value="Win">Win</option>
        <option value="Loss">Loss</option>
      </select>
    </div>
  </div>
  <label>Notes</label>
  <input type="text" id="notes">
  <button onclick="saveTrade()">Save Trade</button>
</div>

<div class="import-export-container">
  <div class="row">
    <div>
      <label>Import CSV</label>
      <input type="file" id="importFile">
    </div>
    <div style="display: flex; align-items: flex-end;">
      <button onclick="importFromCSV()">Import</button>
    </div>
  </div>
  <button onclick="exportToCSV()">Download CSV</button>
</div>

<div class="form-container">
  <h3>Filter Trades</h3>
  <div class="row">
    <div>
      <label>From Date</label>
      <input type="date" id="fromDate">
    </div>
    <div>
      <label>To Date</label>
      <input type="date" id="toDate">
    </div>
  </div>
  <div class="row">
    <div>
      <label>Filter by Pair</label>
      <select id="filterPair">
        <option value="">All</option>
        <option value="EURUSD">EURUSD</option>
        <option value="EURCAD">EURCAD</option>
        <option value="GBPUSD">GBPUSD</option>
        <option value="US30">US30</option>
        <option value="BTCUSD">BTCUSD</option>
      </select>
    </div>
    <div style="display: flex; align-items: flex-end;">
      <button onclick="renderTable()">Apply Filter</button>
    </div>
  </div>
</div>

<div class="form-container table-container">
  <table id="tradeTable">
    <thead>
      <tr>
        <th>Date</th><th>Pair</th><th>H4</th><th>H1</th><th>Zone</th><th>Zone TF</th><th>Entry</th><th>SL</th><th>TP</th><th>SL Size</th><th>RR</th><th>Result</th><th>Notes</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div class="stats-section" id="monthlyStats"></div>

<script>
let trades = JSON.parse(localStorage.getItem("trades")) || [];

function saveTrade() {
  const pair = document.getElementById("pair").value;
  const h4 = document.getElementById("h4").value;
  const h1 = document.getElementById("h1").value;
  const zone = document.getElementById("zone").value;
  const zoneTimeframe = document.getElementById("zoneTimeframe").value;
  const entry = parseFloat(document.getElementById("entry").value);
  const sl = parseFloat(document.getElementById("sl").value);
  const tp = parseFloat(document.getElementById("tp").value);
  const date = document.getElementById("date").value;
  const result = document.getElementById("result").value;
  const notes = document.getElementById("notes").value;

  if (!entry || !sl || !tp || !date) return alert("Please fill all fields");

  const rr = Math.abs(tp - entry) / Math.abs(sl - entry);
  const slSize = Math.abs(sl - entry);

  trades.push({ pair, h4, h1, zone, zoneTimeframe, entry, sl, tp, rr, slSize, date, result, notes });
  localStorage.setItem("trades", JSON.stringify(trades));
  document.getElementById("alert").innerHTML = '<div class="alert-success">Trade saved successfully!</div>';
  setTimeout(() => document.getElementById("alert").innerHTML = '', 3000);
  renderTable();
  renderStats();
}

function exportToCSV() {
  if (!trades.length) return alert("No trades to export");
  const headers = Object.keys(trades[0]).join(",");
  const rows = trades.map(t => Object.values(t).join(","));
  const csvContent = [headers, ...rows].join("\n");
  const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "trades.csv";
  link.click();
}

function importFromCSV() {
  const fileInput = document.getElementById("importFile");
  const file = fileInput.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    const lines = e.target.result.split("\n");
    const keys = lines[0].split(",");
    for (let i = 1; i < lines.length; i++) {
      const values = lines[i].split(",");
      if (values.length !== keys.length) continue;
      const trade = {};
      keys.forEach((k, j) => trade[k] = isNaN(values[j]) ? values[j] : +values[j]);
      trades.push(trade);
    }
    localStorage.setItem("trades", JSON.stringify(trades));
    renderTable();
    renderStats();
  };
  reader.readAsText(file);
}

function renderTable() {
  const fromDate = new Date(document.getElementById("fromDate").value);
  const toDate = new Date(document.getElementById("toDate").value);
  const filterPair = document.getElementById("filterPair").value;

  const tbody = document.getElementById("tradeTable").querySelector("tbody");
  tbody.innerHTML = "";

  trades.filter(t => {
    const d = new Date(t.date);
    return (!isNaN(fromDate) ? d >= fromDate : true) &&
           (!isNaN(toDate) ? d <= toDate : true) &&
           (!filterPair || t.pair === filterPair);
  }).forEach(t => {
    tbody.innerHTML += `<tr>
      <td>${t.date}</td><td>${t.pair}</td><td>${t.h4}</td><td>${t.h1}</td><td>${t.zone}</td><td>${t.zoneTimeframe}</td>
      <td>${t.entry}</td><td>${t.sl}</td><td>${t.tp}</td><td>${t.slSize.toFixed(2)}</td><td>${t.rr.toFixed(2)}</td>
      <td>${t.result}</td><td>${t.notes}</td>
    </tr>`;
  });
}

function renderStats() {
  const statsContainer = document.getElementById("monthlyStats");
  statsContainer.innerHTML = "";
  const statsMap = {};

  trades.forEach(trade => {
    const date = new Date(trade.date);
    const monthLabel = `${date.toLocaleString('default', { month: 'long' })} ${date.getFullYear()}`;
    const key = `${trade.pair}_${monthLabel}`;
    if (!statsMap[key]) statsMap[key] = [];
    statsMap[key].push(trade);
  });

  for (let key in statsMap) {
    const [pair, ...monthArr] = key.split("_");
    const month = monthArr.join(" ");
    const data = statsMap[key];
    const setupCount = data.length;
    const wins = data.filter(t => t.result === "Win").length;
    const losses = setupCount - wins;
    const rrSum = data.reduce((acc, t) => acc + t.rr, 0);
    const winRate = Math.round((wins / setupCount) * 100);

    const canvasId = `chart_${key.replace(/\s+/g, '_')}`;

    statsContainer.innerHTML += `
      <div class="stats-card">
        <h3>${pair} - ${month}</h3>
        <p><strong>Setups:</strong> ${setupCount}</p>
        <p><strong>Wins:</strong> ${wins}</p>
        <p><strong>Win Rate:</strong> ${winRate}%</p>
        <p><strong>Average R:R:</strong> ${(rrSum / setupCount).toFixed(2)}</p>
        <div class="chart-container">
          <canvas id="${canvasId}"></canvas>
        </div>
      </div>
    `;

    setTimeout(() => {
      const ctx = document.getElementById(canvasId).getContext('2d');
      new Chart(ctx, {
        type: 'pie',
        data: {
          labels: ['Wins', 'Losses'],
          datasets: [{ data: [wins, losses], backgroundColor: ['#27ae60', '#e74c3c'] }]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
      });
    }, 100);
  }
}

window.onload = () => { renderTable(); renderStats(); }
</script>
</body>
</html>
